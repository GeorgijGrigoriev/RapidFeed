name: CI

on:
  push:
    branches: ["main", "stages"]
    paths-ignore:
      - "**/*.md"
      - "docs/**"
  pull_request:
    branches: ["main"]
    paths-ignore:
      - "**/*.md"
      - "docs/**"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: "1.25.0"
  NODE_VERSION: "20"
  GOLANGCI_LINT_VERSION: "v2.8.0"
  HTMLHINT_VERSION: "1.8.1"
  STYLELINT_VERSION: "17.1.1"
  STYLELINT_CONFIG_STANDARD_VERSION: "40.0.0"
  TRIVY_VERSION: "v0.69.1"
  COVERAGE_THRESHOLD: "1.0"

jobs:
  changes:
    name: Detect changed paths
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
      - name: Detect changed files
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            frontend:
              - "internal/ui/templates/**/*.html"
              - "internal/templates/**/*.html"
              - "internal/ui/static/**/*.css"
              - "internal/static/**/*.css"
              - ".htmlhintrc"
              - ".stylelintrc.json"
            ci:
              - ".github/workflows/ci.yml"

  build:
    name: Build, lint and test
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - name: Golangci-lint
        uses: golangci/golangci-lint-action@4afd733a84b1f43292c63897423277bb7f4313a9 # v8.0.0
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
      - name: Build
        run: go build -v ./...
      - name: Run tests and enforce coverage threshold
        run: |
          go test -v -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out

          total="$(go tool cover -func=coverage.out | awk '/^total:/ { gsub("%", "", $3); print $3 }')"
          if [ -z "${total}" ]; then
            echo "Failed to parse total coverage from coverage.out"
            exit 1
          fi

          echo "Total coverage: ${total}%"
          awk -v total="${total}" -v threshold="${COVERAGE_THRESHOLD}" 'BEGIN {
            if (total + 0 < threshold + 0) {
              printf("Coverage %.2f%% is below threshold %.2f%%\n", total, threshold)
              exit 1
            }
          }'
      - name: Upload coverage report
        if: ${{ always() && hashFiles('coverage.out') != '' }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: coverage
          path: coverage.out
          retention-days: 7

  frontend_lint:
    name: Frontend lint
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ github.event_name == 'workflow_dispatch' || needs.changes.outputs.frontend == 'true' || needs.changes.outputs.ci == 'true' }}
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Cache npm packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-lint-${{ env.HTMLHINT_VERSION }}-${{ env.STYLELINT_VERSION }}-${{ env.STYLELINT_CONFIG_STANDARD_VERSION }}
          restore-keys: |
            ${{ runner.os }}-npm-lint-
      - name: Install HTML and CSS linters
        run: npm install --no-save "htmlhint@${HTMLHINT_VERSION}" "stylelint@${STYLELINT_VERSION}" "stylelint-config-standard@${STYLELINT_CONFIG_STANDARD_VERSION}"
      - name: Run HTML validation
        run: |
          shopt -s globstar nullglob
          html_files=(internal/ui/templates/**/*.html internal/templates/**/*.html)
          if ((${#html_files[@]} == 0)); then
            echo "No HTML files found, skipping htmlhint."
            exit 0
          fi
          npx htmlhint --config .htmlhintrc "${html_files[@]}"
      - name: Run CSS linting
        run: |
          shopt -s globstar nullglob
          css_files=(internal/ui/static/**/*.css internal/static/**/*.css)
          if ((${#css_files[@]} == 0)); then
            echo "No CSS files found, skipping stylelint."
            exit 0
          fi
          npx stylelint "${css_files[@]}" --allow-empty-input

  security_scan:
    name: Security scan
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
      - name: Build Docker image
        run: docker build -t rapidfeed:ci .
      - name: Generate Trivy JSON report
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          version: ${{ env.TRIVY_VERSION }}
          scan-type: image
          image-ref: rapidfeed:ci
          format: json
          output: trivy-results.json
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          hide-progress: true
      - name: Generate Trivy table report
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          version: ${{ env.TRIVY_VERSION }}
          scan-type: image
          image-ref: rapidfeed:ci
          format: table
          output: trivy-report.txt
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          hide-progress: true
      - name: Upload Trivy reports
        if: ${{ always() && (hashFiles('trivy-results.json') != '' || hashFiles('trivy-report.txt') != '') }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: trivy-reports
          path: |
            trivy-results.json
            trivy-report.txt
          retention-days: 7
      - name: Fail if critical vulnerabilities found
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          version: ${{ env.TRIVY_VERSION }}
          scan-type: image
          image-ref: rapidfeed:ci
          severity: CRITICAL
          ignore-unfixed: true
          exit-code: "1"
          hide-progress: true
